<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subscriber Engagement Segmentation</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@400;600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#f8f9fb;--card:#fff;--card2:#f3f4f7;--border:#e2e5ea;
    --text:#1a1e2a;--muted:#5f6a7d;--accent:#d48a10;--accent2:#c07a0e;
    --dormant:#dc2626;--low:#d97706;--moderate:#4f46e5;--active:#059669;--power:#2563eb;
    --new-user:#7c3aed;--old-user:#64748b;
    --font:'Inter','Noto Sans TC',-apple-system,sans-serif;--mono:'JetBrains Mono',monospace;
  }
  body{background:var(--bg);color:var(--text);font-family:var(--font);line-height:1.6;-webkit-font-smoothing:antialiased}
  .container{max-width:960px;margin:0 auto;padding:0 28px}
  .header{background:linear-gradient(170deg,#eef0f4,#f8f9fb);border-bottom:1px solid var(--border);padding:40px 0 0}
  .header-inner{position:relative}
  .header-tag{display:inline-flex;align-items:center;gap:8px;font-size:11px;letter-spacing:2.5px;text-transform:uppercase;color:var(--accent);margin-bottom:10px}
  .header-tag::before{content:'';display:block;width:6px;height:6px;border-radius:50%;background:var(--accent)}
  .header h1{font-size:30px;font-weight:900;margin-bottom:6px}
  .header p{color:var(--muted);font-size:14px;margin-bottom:24px}
  .tabs{display:flex;gap:2px}
  .tab{padding:10px 22px;font-size:13px;font-weight:500;color:var(--muted);background:0 0;border:1px solid transparent;border-bottom:none;border-radius:8px 8px 0 0;cursor:pointer;transition:all .2s;font-family:var(--font)}
  .tab:hover{color:var(--text)}
  .tab.active{background:var(--card);color:var(--accent);border-color:var(--border);font-weight:700;position:relative;bottom:-1px}
  .content{padding:28px 0 60px}
  .tab-panel{display:none}.tab-panel.active{display:block}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:18px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .card h3{font-size:16px;font-weight:700;margin-bottom:4px}
  .card .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
  .card p{color:var(--muted);font-size:13px;line-height:1.8}
  .stats{display:flex;gap:14px;margin-bottom:24px;flex-wrap:wrap}
  .stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px 22px;flex:1 1 0;min-width:120px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .stat-label{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
  .stat-value{font-size:26px;font-weight:700;font-family:var(--mono);color:var(--accent)}
  .stat-sub{font-size:11px;color:var(--muted);margin-top:4px}
  .tier-bars{display:flex;flex-direction:column;gap:8px}
  .tier-row{display:flex;align-items:center;gap:14px}
  .tier-label{width:90px;text-align:right;flex-shrink:0}
  .tier-name{font-weight:700;font-size:13px}
  .tier-range{font-size:11px;color:var(--muted)}
  .tier-bar-wrap{flex:1;background:rgba(0,0,0,.04);border-radius:6px;height:40px;position:relative;overflow:hidden}
  .tier-bar{height:100%;border-radius:6px;display:flex;align-items:center;padding-left:12px;transition:width .6s ease}
  .tier-bar span{font-size:12px;font-weight:600;color:#fff;white-space:nowrap;text-shadow:0 1px 3px rgba(0,0,0,.4)}
  .tier-pct{width:55px;text-align:right;font-family:var(--mono);font-size:13px;color:var(--muted)}
  .contrib-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .contrib-label{width:80px;font-size:12px;color:var(--muted);text-align:right}
  .contrib-bar-wrap{flex:1;background:rgba(0,0,0,.04);border-radius:4px;height:22px;overflow:hidden}
  .contrib-bar{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px}
  .contrib-bar span{font-size:10px;font-weight:600;color:#fff}
  .contrib-pct{width:50px;text-align:right;font-family:var(--mono);font-size:12px;color:var(--muted)}
  .seg-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .seg-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;border-top:3px solid;box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .seg-header{display:flex;justify-content:space-between;margin-bottom:10px}
  .seg-icon{font-size:22px;margin-bottom:4px}
  .seg-name{font-size:15px;font-weight:700}
  .seg-name-en{font-size:11px;color:var(--muted)}
  .seg-count{font-size:24px;font-weight:700;font-family:var(--mono)}
  .seg-meta{font-size:11px;color:var(--muted)}
  .seg-action{color:var(--accent);font-weight:600;font-size:13px;margin-bottom:8px}
  .seg-desc{font-size:12px;color:var(--muted);line-height:1.7}
  .seg-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:10px;border-top:1px solid var(--border)}
  .seg-footer .meta{font-size:11px;color:var(--muted)}
  .highlight{border-radius:10px;padding:20px;margin-bottom:18px}
  .highlight.green{background:rgba(5,150,105,.06);border:1px solid rgba(5,150,105,.2)}
  .highlight.amber{background:rgba(212,138,16,.06);border:1px solid rgba(212,138,16,.2)}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px}
  .indicator{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
  .indicator.new{background:rgba(124,58,237,.1);color:var(--new-user);border:1px solid rgba(124,58,237,.25)}
  .indicator.old{background:rgba(100,116,139,.1);color:var(--old-user);border:1px solid rgba(100,116,139,.25)}
  .indicator.tier-i{background:rgba(79,70,229,.08);color:var(--moderate);border:1px solid rgba(79,70,229,.2)}
  .upload-zone{border:2px dashed var(--border);border-radius:16px;padding:48px 32px;text-align:center;margin-bottom:24px;transition:all .2s;cursor:pointer;background:var(--card)}
  .upload-zone:hover,.upload-zone.dragover{border-color:var(--accent);background:rgba(212,138,16,.03)}
  .upload-zone h2{font-size:20px;font-weight:700;margin-bottom:8px}
  .upload-zone p{color:var(--muted);font-size:14px}
  .upload-zone input{display:none}
  .file-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;border:1px solid var(--active);color:var(--active);background:rgba(5,150,105,.06);margin-top:16px}
  .month-selector{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
  .month-selector label{font-size:13px;color:var(--muted);font-weight:600}
  .month-btn{padding:6px 16px;border-radius:8px;font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;transition:all .15s;font-family:var(--mono)}
  .month-btn:hover{border-color:var(--accent);color:var(--text)}
  .month-btn.active{border-color:var(--accent);background:rgba(212,138,16,.08);color:var(--accent)}
  .migration-selectors{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
  .migration-selectors select{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-family:var(--mono);font-size:13px;color:var(--text);cursor:pointer}
  .migration-selectors select:focus{outline:none;border-color:var(--accent)}
  .migration-selectors .arrow{font-size:18px;color:var(--accent);font-weight:700}
  .mig-table{width:100%;border-collapse:collapse;font-size:12px;margin:12px 0}
  .mig-table th{padding:8px;border-bottom:2px solid var(--border);color:var(--accent);font-weight:600;font-size:11px;text-align:center;letter-spacing:.3px}
  .mig-table th:first-child{text-align:left}
  .mig-table td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:center;font-family:var(--mono);font-size:11px;color:var(--muted)}
  .mig-table td:first-child{text-align:left;color:var(--text);font-weight:600;font-family:var(--font)}
  .mig-table td.highlight-cell{background:rgba(212,138,16,.08);color:var(--text);font-weight:600}
  .mig-table td.up{color:var(--active)}
  .mig-table td.down{color:var(--dormant)}
  .empty-state{color:var(--muted);text-align:center;padding:60px 0}
  .lang-toggle{position:absolute;right:0;top:4px;padding:6px 16px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-size:12px;font-weight:700;cursor:pointer;color:var(--muted);transition:all .15s;font-family:var(--font);box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .lang-toggle:hover{border-color:var(--accent);color:var(--accent)}
  .dl-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:6px;border:1px solid var(--border);background:var(--card2);color:var(--muted);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;font-family:var(--font)}
  .dl-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(212,138,16,.06)}
  @media(max-width:700px){.stats,.two-col,.seg-grid{grid-template-columns:1fr}.stats{flex-direction:column}.lang-toggle{position:static;margin-bottom:12px}}
</style>
</head>
<body>

<div class="header">
  <div class="container header-inner">
    <button class="lang-toggle" id="langToggle" onclick="toggleLang()">ä¸­æ–‡</button>
    <div class="header-tag">Subscriber Segmentation Report</div>
    <h1 id="hTitle"></h1>
    <p id="hSub"></p>
    <div class="tabs" id="tabBar"></div>
  </div>
</div>

<div class="container content">
  <div id="tab-upload" class="tab-panel active"><div id="uploadPane"></div></div>
  <div id="tab-overview" class="tab-panel">
    <div id="ov-month-sel"></div>
    <div id="ov-content"></div>
  </div>
  <div id="tab-actions" class="tab-panel">
    <div id="ac-month-sel"></div>
    <div id="ac-content"></div>
  </div>
  <div id="tab-migration" class="tab-panel">
    <div id="mig-selectors"></div>
    <div id="mig-content"></div>
  </div>
</div>

<script>
/* ================================================================
   CONFIG
   ================================================================ */
const TIER_BREAKS = [10, 70, 300, 1000];
const TIER_NAMES = ['Dormant','Low','Moderate','Active','Power'];
const TIER_RANGES = ['â‰¤ 10 PV','11â€“70 PV','71â€“300 PV','301â€“1,000 PV','1,001+ PV'];
const TIER_COLORS = ['var(--dormant)','var(--low)','var(--moderate)','var(--active)','var(--power)'];
const TIER_GRADS = ['linear-gradient(90deg,#dc2626,#dc2626aa)','linear-gradient(90deg,#d97706,#d97706aa)','linear-gradient(90deg,#4f46e5,#4f46e5aa)','linear-gradient(90deg,#059669,#059669aa)','linear-gradient(90deg,#2563eb,#2563ebaa)'];
const NEW_YEAR = 2025;

/* ================================================================
   STATE
   ================================================================ */
let lang='en', monthlyData={}, sortedMonths=[], curTab='upload';
let selMo={overview:null,actions:null};
let migPrev=null, migCurr=null, lastFile='';

/* ================================================================
   i18n HELPER
   ================================================================ */
const L = (en,zh) => lang==='en'?en:zh;

/* ================================================================
   UTILITY
   ================================================================ */
function parseDate(s){
  if(!s||!s.trim())return null;
  const p=s.trim().split('/');
  if(p.length===3) return new Date(+p[2],+p[1]-1,+p[0]);
  const d=new Date(s); return isNaN(d)?null:d;
}
function getTier(pv){if(pv<=TIER_BREAKS[0])return 0;if(pv<=TIER_BREAKS[1])return 1;if(pv<=TIER_BREAKS[2])return 2;if(pv<=TIER_BREAKS[3])return 3;return 4;}
function pct(v){return v.toFixed(1)+'%'}
function num(v){return v.toLocaleString()}

/* ================================================================
   CSV PROCESSING
   ================================================================ */
function processCSV(csv){
  const res=Papa.parse(csv.trim(),{header:true,skipEmptyLines:true});
  if(!res.data.length)return null;
  const byM={};
  for(const r of res.data){const m=(r.data_month||'').trim();if(!m)continue;(byM[m]=byM[m]||[]).push(r);}
  const out={};
  for(const [month,rows] of Object.entries(byM)){
    const mm={};
    for(const r of rows){
      const id=r.ej_mid;if(!id)continue;
      if(!mm[id])mm[id]={ej_mid:id,rds:r.member_createdate||'',tpv:0,apv:0,plats:new Set()};
      mm[id].tpv+=parseInt(r.total_page_views)||0;
      mm[id].apv+=parseInt(r.article_page_views)||0;
      if(r.platform)mm[id].plats.add(r.platform);
    }
    out[month]={month,members:Object.values(mm).map(m=>{
      const rd=parseDate(m.rds),ry=rd?rd.getFullYear():null,rm=rd?rd.getMonth()+1:null;
      const ti=getTier(m.tpv),isNew=ry!==null&&ry>=NEW_YEAR;
      let sub=null;
      if(ti===0)sub=isNew?'New Inactive':'Churning Veteran';
      else if(ti===1)sub=isNew?'New Explorer':'Declining Regular';
      return{ej_mid:m.ej_mid,total_pv:m.tpv,article_pv:m.apv,article_ratio:m.tpv>0?m.apv/m.tpv:0,platforms:m.plats.size,regDate:rd,regYear:ry,regMonth:rm,isNew,tierIdx:ti,tier:TIER_NAMES[ti],subsegment:sub};
    })};
  }
  return out;
}

function computeStats(members,dataMonth){
  const total=members.length,totalPV=members.reduce((s,m)=>s+m.total_pv,0);
  const [dmY,dmM]=dataMonth.split('-').map(Number);
  const newThisMonth=members.filter(m=>m.regYear===dmY&&m.regMonth===dmM).length;
  const cutoff=new Date(dmY,dmM-1-12,1);
  const recent12m=members.filter(m=>m.regDate&&m.regDate>=cutoff).length;
  const crossPlat=members.filter(m=>m.platforms>=2).length;
  const pvs=members.map(m=>m.total_pv).sort((a,b)=>a-b),median=pvs[Math.floor(total/2)]||0;
  const avgAR=total>0?members.reduce((s,m)=>s+m.article_ratio,0)/total:0;
  const tiers=TIER_NAMES.map((name,i)=>{
    const g=members.filter(m=>m.tierIdx===i),gn=g.filter(m=>m.isNew),gc=g.filter(m=>m.platforms>=2),gPV=g.reduce((s,m)=>s+m.total_pv,0);
    return{name,idx:i,count:g.length,pct:total>0?g.length/total*100:0,newPct:g.length>0?gn.length/g.length*100:0,crossPct:g.length>0?gc.length/g.length*100:0,pvShare:totalPV>0?gPV/totalPV*100:0,avgAR:g.length>0?g.reduce((s,m)=>s+m.article_ratio,0)/g.length:0};
  });
  const subs={
    'Churning Veteran':members.filter(m=>m.subsegment==='Churning Veteran'),
    'New Inactive':members.filter(m=>m.subsegment==='New Inactive'),
    'Declining Regular':members.filter(m=>m.subsegment==='Declining Regular'),
    'New Explorer':members.filter(m=>m.subsegment==='New Explorer'),
  };
  return{total,totalPV,newThisMonth,recent12m,crossPlat,median,avgAR,tiers,subs};
}

/* ================================================================
   DOWNLOAD SEGMENT CSV
   ================================================================ */
function dlSeg(key){
  const mo=selMo.actions;if(!mo||!monthlyData[mo])return;
  const all=monthlyData[mo].members;
  let f;
  if(key==='Moderate')f=all.filter(m=>m.tierIdx===2);
  else if(key==='Power')f=all.filter(m=>m.tierIdx===4);
  else f=all.filter(m=>m.subsegment===key);
  if(!f||!f.length)return;
  const rows=f.map(m=>({ej_mid:m.ej_mid,total_page_views:m.total_pv,article_page_views:m.article_pv,article_ratio:(m.article_ratio*100).toFixed(1)+'%',platforms:m.platforms,tier:m.tier,subsegment:m.subsegment||m.tier}));
  const csv=Papa.unparse(rows);
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`${key.replace(/\s+/g,'-').toLowerCase()}_${mo}.csv`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}
window.dlSeg=dlSeg;

/* ================================================================
   RENDER: STATIC SHELL
   ================================================================ */
function renderShell(){
  document.title=L('Subscriber Engagement Segmentation','è¨‚é–±è€…æ´»èºåº¦åˆ†å±¤åˆ†æ');
  document.getElementById('langToggle').textContent=lang==='en'?'ä¸­æ–‡':'EN';
  document.getElementById('hTitle').textContent=L('Subscriber Engagement Segmentation','è¨‚é–±è€…æ´»èºåº¦åˆ†å±¤åˆ†æ');
  if(!sortedMonths.length) document.getElementById('hSub').textContent=L('Upload CSV to begin Â· K-Means validated breakpoints [10, 70, 300, 1000]','ä¸Šè¼‰ CSV é–‹å§‹åˆ†æ Â· K-Means é©—è­‰æ–·é» [10, 70, 300, 1000]');
  document.getElementById('tabBar').innerHTML=[
    ['upload','ğŸ“',L('Upload','ä¸Šè¼‰æ•¸æ“š')],
    ['overview','ğŸ“Š',L('Overview','åˆ†å±¤ç¸½è¦½')],
    ['actions','ğŸš€',L('Actions','è¡Œå‹•å»ºè­°')],
    ['migration','ğŸ”„',L('Migration','æœˆåº¦é·ç§»')]
  ].map(([id,ico,label])=>`<button class="tab ${curTab===id?'active':''}" data-tab="${id}" onclick="switchTab('${id}')">${ico} ${label}</button>`).join('');
  renderUploadPane();
}

function renderUploadPane(){
  const fp=lastFile?buildPill():'';
  document.getElementById('uploadPane').innerHTML=`
    <div class="upload-zone" id="dropZone" onclick="document.getElementById('csvInput').click()">
      <h2>ğŸ“‚ ${L('Drag & Drop or Click to Upload CSV','æ‹–æ”¾æˆ–é»æ“Šä¸Šè¼‰ CSV')}</h2>
      <p>${L('Format','æ ¼å¼')}: ej_mid, member_createdate, data_month, platform, total_page_views, article_page_views</p>
      <p style="margin-top:8px;font-size:12px;color:var(--muted)">${L('CSV may contain multiple months (auto-split by data_month)','CSV å¯åŒ…å«å¤šå€‹æœˆä»½ï¼ˆé€é data_month è‡ªå‹•æ‹†åˆ†ï¼‰')}</p>
      <input type="file" id="csvInput" accept=".csv"><div id="filePill">${fp}</div>
    </div>
    <div class="card">
      <h3>${L('Instructions','ä½¿ç”¨èªªæ˜')}</h3><div class="sub">${L('One CSV for all analyses','ä¸€å€‹ CSV å®Œæˆæ‰€æœ‰åˆ†æ')}</div>
      <p><strong style="color:var(--text)">â‘  ${L('Single month:','å–®æœˆï¼š')}</strong> ${L('CSV with one data_month â€” shows full analysis.','CSV åªæœ‰ä¸€å€‹ data_month â†’ é¡¯ç¤ºå®Œæ•´åˆ†æã€‚')}</p>
      <p style="margin-top:8px"><strong style="color:var(--text)">â‘¡ ${L('Multiple months:','å¤šæœˆï¼š')}</strong> ${L('Switch months per tab; Migration compares any two.','å„ tab å¯åˆ‡æ›æœˆä»½ï¼›ã€Œé·ç§»ã€å¯æ¯”è¼ƒä»»æ„å…©æœˆã€‚')}</p>
      <p style="margin-top:8px"><strong style="color:var(--text)">â‘¢ ${L('Privacy:','éš±ç§ï¼š')}</strong> ${L('All calculations run locally. No data leaves your browser.','æ‰€æœ‰è¨ˆç®—åœ¨ç€è¦½å™¨æœ¬åœ°å®Œæˆï¼Œæ•¸æ“šä¸æœƒä¸Šå‚³ã€‚')}</p>
    </div>`;
  bindUpload();
}

function buildPill(){
  const n=Object.values(monthlyData).reduce((s,d)=>s+d.members.length,0);
  return `<div class="file-pill">ğŸ“„ ${lastFile} <span style="color:var(--muted);font-weight:400">${sortedMonths.length} ${L('month(s)','å€‹æœˆä»½')} Â· ${num(n)} ${L('records','ç­†è¨˜éŒ„')}</span></div>`;
}

function updateSubtitle(){
  const latest=sortedMonths[sortedMonths.length-1];
  document.getElementById('hSub').textContent=sortedMonths.length===1
    ?`${latest} Â· ${num(monthlyData[latest].members.length)} ${L('subscribers','ä½è¨‚é–±è€…')} Â· ${L('Breakpoints','æ–·é»')} [${TIER_BREAKS.join(', ')}]`
    :`${sortedMonths[0]} â€“ ${latest} (${sortedMonths.length} ${L('months','å€‹æœˆ')}) Â· ${L('Breakpoints','æ–·é»')} [${TIER_BREAKS.join(', ')}]`;
}

/* ================================================================
   RENDER: MONTH SELECTOR
   ================================================================ */
function renderMonthSel(months,sel,fn,cid){
  const el=document.getElementById(cid);
  if(months.length<=1){el.innerHTML='';return;}
  el.innerHTML=`<div class="month-selector"><label>${L('Select month:','é¸æ“‡æœˆä»½ï¼š')}</label>${months.map(m=>`<button class="month-btn ${m===sel?'active':''}" onclick="${fn}('${m}')">${m}</button>`).join('')}</div>`;
}

/* ================================================================
   RENDER: OVERVIEW
   ================================================================ */
function renderOverview(st,month){
  const ti=st.tiers;
  return `
  <div class="stats">
    <div class="stat"><div class="stat-label">${L('Total Subscribers','ç¸½è¨‚é–±è€…')}</div><div class="stat-value">${num(st.total)}</div><div class="stat-sub">${month}</div></div>
    <div class="stat"><div class="stat-label">${L('New This Month','æœ¬æœˆæ–°ç”¨æˆ¶')}</div><div class="stat-value" style="color:var(--new-user)">${num(st.newThisMonth)}</div><div class="stat-sub">${L('Registered in','è¨»å†Šæ–¼')} ${month}</div></div>
    <div class="stat"><div class="stat-label">${L('Recent 12m','è¿‘12æœˆæ–°ç”¨æˆ¶')}</div><div class="stat-value" style="color:var(--active)">${num(st.recent12m)}</div><div class="stat-sub">${pct(st.total>0?st.recent12m/st.total*100:0)} ${L('of total','ä½”ç¸½æ•¸')}</div></div>
    <div class="stat"><div class="stat-label">${L('Median PV','ä¸­ä½æ•¸ PV')}</div><div class="stat-value">${num(st.median)}</div><div class="stat-sub">${L('Per user / month','æ¯äººæ¯æœˆ')}</div></div>
    <div class="stat"><div class="stat-label">${L('Cross-Platform','è·¨å¹³å°')}</div><div class="stat-value">${pct(st.crossPlat/st.total*100)}</div><div class="stat-sub">App + Web</div></div>
  </div>
  <div class="card"><h3>${L('Five-Tier Engagement Model','äº”ç´šæ´»èºåº¦æ¨¡å‹')}</h3><div class="sub">${L('Breakpoints','æ–·é»')} [${TIER_BREAKS.join(', ')}]</div>
    <div class="tier-bars">${ti.map((t,i)=>`<div class="tier-row"><div class="tier-label"><div class="tier-name" style="color:${TIER_COLORS[i]}">${t.name}</div><div class="tier-range">${TIER_RANGES[i]}</div></div><div class="tier-bar-wrap"><div class="tier-bar" style="width:${Math.max(t.pct,3)}%;background:${TIER_GRADS[i]}"><span>${num(t.count)}</span></div></div><div class="tier-pct">${pct(t.pct)}</div></div>`).join('')}</div>
  </div>
  <div class="two-col">
    <div class="card"><h3>${L('Traffic Contribution','æµé‡è²¢ç»ä½”æ¯”')}</h3><div class="sub">${L("Each tier's share of total PV",'å„å±¤å°ç¸½ PV çš„è²¢ç»')}</div>
      ${ti.map((t,i)=>`<div class="contrib-row"><div class="contrib-label">${t.name}</div><div class="contrib-bar-wrap"><div class="contrib-bar" style="width:${Math.max(t.pvShare,2)}%;background:${TIER_COLORS[i]}"><span>${t.pvShare>8?pct(t.pvShare):''}</span></div></div><div class="contrib-pct">${pct(t.pvShare)}</div></div>`).join('')}
      <p style="margin-top:14px;font-size:12px">${L(`Power users are ${pct(ti[4].pct)} of users but contribute`,`Power ä½” ${pct(ti[4].pct)} äººæ•¸ï¼Œè²¢ç»äº†`)} <strong style="color:var(--text)">${pct(ti[4].pvShare)}</strong> ${L('of total traffic.','çš„ç¸½æµé‡ã€‚')}</p>
    </div>
    <div class="card"><h3>${L('New User Ratio by Tier','å„å±¤æ–°ç”¨æˆ¶æ¯”ä¾‹')}</h3><div class="sub">${L(`New users (${NEW_YEAR}+) in each tier`,`æ–°ç”¨æˆ¶ï¼ˆ${NEW_YEAR}+ï¼‰åœ¨å„å±¤ä½”æ¯”`)}</div>
      ${ti.map(t=>`<div class="contrib-row"><div class="contrib-label">${t.name}</div><div class="contrib-bar-wrap"><div class="contrib-bar" style="width:${Math.max(t.newPct,1)}%;background:var(--new-user)"><span></span></div></div><div class="contrib-pct">${pct(t.newPct)}</div></div>`).join('')}
    </div>
  </div>
  <div class="card"><h3>${L('Cross-Platform vs Engagement','è·¨å¹³å°ä½¿ç”¨ vs æ´»èºåº¦')}</h3><div class="sub">${L('Users on both App + Web','åŒæ™‚ä½¿ç”¨ App + Web çš„æ¯”ä¾‹')}</div>
    ${ti.map(t=>`<div class="contrib-row"><div class="contrib-label">${t.name}</div><div class="contrib-bar-wrap"><div class="contrib-bar" style="width:${Math.max(t.crossPct,1)}%;background:var(--accent)"><span>${t.crossPct>15?pct(t.crossPct):''}</span></div></div><div class="contrib-pct">${pct(t.crossPct)}</div></div>`).join('')}
  </div>`;
}

/* ================================================================
   RENDER: ACTIONS (merged Low-Activity + Actions)
   ================================================================ */
function renderActions(st,members){
  const ti=st.tiers;
  const totalLow=['Churning Veteran','New Inactive','Declining Regular','New Explorer'].reduce((s,k)=>s+st.subs[k].length,0);
  const groups=[
    {key:'New Inactive',pri:'ğŸ¥‡',icon:'ğŸŸ£',color:'var(--new-user)',badge:'new',
     name:L('New Inactive','æœªå•Ÿå‹•æ–°ç”¨æˆ¶'),sub:L('Dormant Â· New user','Dormant å±¤ Â· æ–°ç”¨æˆ¶'),
     action:L('Fix Onboarding','ä¿®è£œ Onboarding'),
     desc:L('Barely used after sign-up. Analyze sign-up channels â†’ Day 1/3/7 automated onboarding â†’ Track Day-7/30 retention.','è¨»å†Šå¾Œå¹¾ä¹ç„¡ä½¿ç”¨ã€‚åˆ†æè¨»å†Šæ¸ é“ â†’ è¨­è¨ˆ Day 1/3/7 è‡ªå‹•å¼•å° â†’ è¿½è¹¤ Day-7/30 ç•™å­˜ç‡ã€‚'),
     m:st.subs['New Inactive']},
    {key:'Declining Regular',pri:'ğŸ¥ˆ',icon:'ğŸŸ ',color:'var(--low)',badge:'old',
     name:L('Declining Regular','æ·ºå±¤è€ç”¨æˆ¶'),sub:L('Low Â· Existing user','Low å±¤ Â· èˆŠç”¨æˆ¶'),
     action:L('Re-engagement','Re-engagement'),
     desc:L('Visits but uses little. Segment by article ratio for push strategy; A/B test re-engagement messages.','æœ‰ä¾†ä½†ç”¨å¾—å°‘ã€‚ç”¨ article ratio åˆ†æµæ¨é€ï¼ŒA/B æ¸¬è©¦ re-engagement è¨Šæ¯ã€‚'),
     m:st.subs['Declining Regular']},
    {key:'Moderate',pri:'ğŸ¥‰',icon:'ğŸ“ˆ',color:'var(--moderate)',badge:'tier',
     name:L('Moderate â†’ Active','Moderate â†’ Active'),sub:L('Moderate Â· Push up','Moderate å±¤ Â· æ¨å‘ Active'),
     action:L('Push to Active','æ¨å‹•å‡ç´š'),
     desc:L(`Encourage cross-platform (currently ${pct(ti[2].crossPct)} dual) â†’ reading achievement milestones.`,`é¼“å‹µè·¨å¹³å°ä½¿ç”¨ï¼ˆç›®å‰ ${pct(ti[2].crossPct)} é›™å¹³å°ï¼‰â†’ é–±è®€æˆå°±æ©Ÿåˆ¶ã€‚`),
     m:members.filter(m=>m.tierIdx===2)},
    {key:'Churning Veteran',pri:'â‘£',icon:'ğŸ”´',color:'var(--dormant)',badge:'old',
     name:L('Churning Veteran','æµå¤±è€ç”¨æˆ¶'),sub:L('Dormant Â· Existing user','Dormant å±¤ Â· èˆŠç”¨æˆ¶'),
     action:L('Reactivation','å†æ¿€æ´»'),
     desc:L('PV â‰¤ 10, long-standing users â€” nearly churned. Personalized push/email to win them back.','æœˆ PV â‰¤ 10 çš„èˆŠç”¨æˆ¶ï¼Œå¹¾ä¹å·²æµå¤±ã€‚å»ºè­° push / email å€‹äººåŒ–æ¨è–¦å˜—è©¦æ‹‰å›ã€‚'),
     m:st.subs['Churning Veteran']},
    {key:'New Explorer',pri:'â‘¤',icon:'ğŸ”®',color:'#7c3aed',badge:'new',
     name:L('New Explorer','æ¢ç´¢ä¸­æ–°ç”¨æˆ¶'),sub:L('Low Â· New user','Low å±¤ Â· æ–°ç”¨æˆ¶'),
     action:L('Nurture','åŸ¹è‚²'),
     desc:L('Some usage, no habit. Guide content discovery, set preferences, milestone rewards.','æœ‰ä½¿ç”¨ä½†æœªé¤Šæˆç¿’æ…£ã€‚å¼•å°ç™¼ç¾æ›´å¤šå…§å®¹ã€è¨­è¨ˆé‡Œç¨‹ç¢‘çå‹µã€‚'),
     m:st.subs['New Explorer']},
    {key:'Power',pri:'ğŸ›¡ï¸',icon:'âš¡',color:'var(--power)',badge:'tier',
     name:L('Retain Power Users','ç¶­è­· Power User'),sub:L('Power Â· Protect','Power å±¤ Â· é˜²æµå¤±'),
     action:L('Retention','ç•™å­˜ç¶­è­·'),
     desc:L(`They contribute ${pct(ti[4].pvShare)} of traffic. PV drop >30% alerts â†’ VIP rewards, exclusive content.`,`è²¢ç»äº† ${pct(ti[4].pvShare)} ç¸½æµé‡ã€‚å»ºç«‹ PV ä¸‹é™ >30% é è­¦ â†’ VIP å›é¥‹ã€å°ˆå±¬å…§å®¹ã€‚`),
     m:members.filter(m=>m.tierIdx===4)},
  ];
  const badge=(b)=>b==='new'?`<span class="indicator new">${L('New','æ–°ç”¨æˆ¶')}</span>`:b==='old'?`<span class="indicator old">${L('Existing','èˆŠç”¨æˆ¶')}</span>`:`<span class="indicator tier-i">${L('Full Tier','å…¨å±¤')}</span>`;
  return `
  <div class="highlight green">
    <h3 style="font-size:15px;font-weight:700;color:var(--active);margin-bottom:8px">${L('Prioritized Action Plan','å„ªå…ˆç´šè¡Œå‹•å»ºè­°')}</h3>
    <p style="font-size:13px;color:var(--muted)">${L(`Dormant + Low: ${num(totalLow)} users (${pct(totalLow/st.total*100)}). 6 action groups by priority â€” each with downloadable member list.`,`Dormant + Low å…± ${num(totalLow)} äººï¼ˆ${pct(totalLow/st.total*100)}ï¼‰ã€‚ä»¥ä¸‹ 6 çµ„è¡Œå‹•å»ºè­°æŒ‰å„ªå…ˆç´šæ’åˆ—ï¼Œæ¯çµ„å¯ä¸‹è¼‰æˆå“¡åå–®ã€‚`)}</p>
  </div>
  <div class="seg-grid">${groups.map(g=>{
    const cnt=g.m.length,ar=cnt>0?(g.m.reduce((a,m)=>a+m.article_ratio,0)/cnt*100).toFixed(0):0;
    return `
    <div class="seg-card" style="border-top-color:${g.color}">
      <div class="seg-header">
        <div><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:18px">${g.pri}</span><span style="font-size:20px">${g.icon}</span></div>
          <div class="seg-name" style="color:${g.color}">${g.name}</div><div class="seg-name-en">${g.sub}</div></div>
        <div style="text-align:right"><div class="seg-count">${num(cnt)}</div><div class="seg-meta">${badge(g.badge)}</div></div>
      </div>
      <div class="seg-action">${L('Action:','å»ºè­°ï¼š')} ${g.action}</div>
      <div class="seg-desc">${g.desc}</div>
      <div class="seg-footer">
        <div class="meta">${L('Avg Article Ratio:','å¹³å‡ Article Ratioï¼š')} ${ar}%</div>
        <button class="dl-btn" onclick="dlSeg('${g.key}')">ğŸ“¥ ${L('Download','ä¸‹è¼‰')} CSV (${num(cnt)})</button>
      </div>
    </div>`;}).join('')}
  </div>
  <div class="highlight amber" style="margin-top:18px">
    <h3 style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ’¡ Article Ratio</h3>
    <p style="font-size:13px;color:var(--muted)">${L('Overall avg:','æ•´é«”å¹³å‡ï¼š')} ${(st.avgAR*100).toFixed(0)}% | Power: ${(ti[4].avgAR*100).toFixed(0)}% | Dormant: ${(ti[0].avgAR*100).toFixed(0)}%</p>
  </div>`;
}

/* ================================================================
   RENDER: MIGRATION
   ================================================================ */
function renderMigMatrix(){
  if(!migPrev||!migCurr||migPrev===migCurr){document.getElementById('mig-content').innerHTML=`<p class="empty-state">${L('Please select two different months','è«‹é¸æ“‡å…©å€‹ä¸åŒçš„æœˆä»½')}</p>`;return;}
  const prev=monthlyData[migPrev],curr=monthlyData[migCurr];if(!prev||!curr)return;
  const pm={},cm={};
  for(const m of prev.members)pm[m.ej_mid]=m.tierIdx;
  for(const m of curr.members)cm[m.ej_mid]=m.tierIdx;
  const ids=new Set([...Object.keys(pm),...Object.keys(cm)]);
  const mx=Array.from({length:5},()=>Array(5).fill(0));
  let nb=Array(5).fill(0),lb=Array(5).fill(0),ret=0;
  for(const id of ids){const p=pm[id],c=cm[id];if(p!==undefined&&c!==undefined){mx[p][c]++;ret++;}else if(p!==undefined)lb[p]++;else nb[c]++;}
  let up=0,dn=0,same=0;
  for(let f=0;f<5;f++)for(let t=0;t<5;t++){if(t>f)up+=mx[f][t];else if(t<f)dn+=mx[f][t];else same+=mx[f][t];}
  const tn=nb.reduce((a,b)=>a+b,0),tl=lb.reduce((a,b)=>a+b,0);
  let h=`<div class="card"><h3>ğŸ”„ ${L('Monthly Migration Matrix','æœˆåº¦é·ç§»çŸ©é™£')}</h3><div class="sub">${migPrev} â†’ ${migCurr}</div>
  <p style="margin-bottom:16px">${L('Row = previous month, Column = current. Diagonal = retained.','è¡Œ = ä¸Šæœˆï¼Œåˆ— = æœ¬æœˆã€‚å°è§’ç·š = ç•™å­˜ã€‚')} ${L('Upper-right =','å³ä¸Š =')} <span style="color:var(--active)">${L('upgraded','å‡ç´š')}</span>, ${L('Lower-left =','å·¦ä¸‹ =')} <span style="color:var(--dormant)">${L('downgraded','é™ç´š')}</span>.</p>
  <table class="mig-table"><thead><tr><th>${migPrev} \\ ${migCurr}</th>${TIER_NAMES.map(n=>`<th>${n}</th>`).join('')}<th>${L('Churned','æµå¤±')}</th><th>${L('Total','åˆè¨ˆ')}</th></tr></thead><tbody>`;
  for(let f=0;f<5;f++){const rt=mx[f].reduce((a,b)=>a+b,0)+lb[f];h+=`<tr><td>${TIER_NAMES[f]}</td>`;for(let t=0;t<5;t++){const v=mx[f][t],cls=f===t?'highlight-cell':t>f?'up':'down';h+=`<td class="${cls}">${v||'-'}</td>`;}h+=`<td class="down">${lb[f]||'-'}</td><td style="color:var(--text);font-weight:600">${num(rt)}</td></tr>`;}
  h+=`<tr><td style="color:var(--active)">${L('New','æ–°é€²')}</td>${nb.map(v=>`<td class="up">${v||'-'}</td>`).join('')}<td>-</td><td style="color:var(--active);font-weight:600">${num(tn)}</td></tr></tbody></table></div>`;
  h+=`<div class="stats">
    <div class="stat"><div class="stat-label">${L('Retained','ç•™åœ¨åŒå±¤')}</div><div class="stat-value" style="color:var(--muted)">${num(same)}</div><div class="stat-sub">${ret>0?pct(same/ret*100):'-'}</div></div>
    <div class="stat"><div class="stat-label">${L('Upgraded','å‡ç´š')} â†‘</div><div class="stat-value" style="color:var(--active)">${num(up)}</div><div class="stat-sub">${ret>0?pct(up/ret*100):'-'}</div></div>
    <div class="stat"><div class="stat-label">${L('Downgraded','é™ç´š')} â†“</div><div class="stat-value" style="color:var(--dormant)">${num(dn)}</div><div class="stat-sub">${ret>0?pct(dn/ret*100):'-'}</div></div>
    <div class="stat"><div class="stat-label">${L('New','æ–°é€²')}</div><div class="stat-value" style="color:var(--active)">${num(tn)}</div><div class="stat-sub">${L('Not in prev month','ä¸Šæœˆç„¡è¨˜éŒ„')}</div></div>
    <div class="stat"><div class="stat-label">${L('Churned','æµå¤±')}</div><div class="stat-value" style="color:var(--dormant)">${num(tl)}</div><div class="stat-sub">${L('Not in curr month','æœ¬æœˆç„¡è¨˜éŒ„')}</div></div>
  </div>
  <div class="highlight amber"><h3 style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:6px">${L('How to Read','å¦‚ä½•è§£è®€')}</h3><p style="font-size:13px;color:var(--muted)"><strong style="color:var(--text)">${L('Larger diagonal = better','å°è§’ç·šè¶Šå¤§è¶Šå¥½')}</strong> ${L('(stable). Watch Active/Power downgrades and Power churns. Analyze upgrades to replicate success.','ï¼ˆç©©å®šï¼‰ã€‚é—œæ³¨ Active/Power é™ç´šåŠ Power æµå¤±ã€‚åˆ†æå‡ç´šè€…çš„æˆåŠŸåŸå› ã€‚')}</p></div>`;
  document.getElementById('mig-content').innerHTML=h;
}

function renderMigSel(months){
  const c=document.getElementById('mig-selectors');
  if(months.length<2){c.innerHTML='';document.getElementById('mig-content').innerHTML=`<p class="empty-state">${L('At least two months required','éœ€è¦è‡³å°‘å…©å€‹æœˆä»½')}</p>`;return;}
  migPrev=migPrev||months[months.length-2];migCurr=migCurr||months[months.length-1];
  c.innerHTML=`<div class="migration-selectors"><label style="font-size:13px;color:var(--muted);font-weight:600">${L('Previous:','ä¸Šæœˆï¼š')}</label><select id="migPrevSel" onchange="onMigChg()">${months.map(m=>`<option value="${m}" ${m===migPrev?'selected':''}>${m}</option>`).join('')}</select><span class="arrow">â†’</span><label style="font-size:13px;color:var(--muted);font-weight:600">${L('Current:','æœ¬æœˆï¼š')}</label><select id="migCurrSel" onchange="onMigChg()">${months.map(m=>`<option value="${m}" ${m===migCurr?'selected':''}>${m}</option>`).join('')}</select></div>`;
  renderMigMatrix();
}

/* ================================================================
   MONTH HANDLERS
   ================================================================ */
function selOv(m){selMo.overview=m;renderMonthSel(sortedMonths,m,'selOv','ov-month-sel');document.getElementById('ov-content').innerHTML=renderOverview(computeStats(monthlyData[m].members,m),m);}
function selAc(m){selMo.actions=m;renderMonthSel(sortedMonths,m,'selAc','ac-month-sel');document.getElementById('ac-content').innerHTML=renderActions(computeStats(monthlyData[m].members,m),monthlyData[m].members);}
function onMigChg(){migPrev=document.getElementById('migPrevSel').value;migCurr=document.getElementById('migCurrSel').value;renderMigMatrix();}
window.selOv=selOv;window.selAc=selAc;window.onMigChg=onMigChg;

/* ================================================================
   FILE HANDLING
   ================================================================ */
function bindUpload(){
  const dz=document.getElementById('dropZone'),ci=document.getElementById('csvInput');
  if(!dz||!ci)return;
  ci.addEventListener('change',e=>{if(e.target.files[0])handleFile(e.target.files[0]);});
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0]);});
}

function handleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const data=processCSV(e.target.result);
    if(!data||!Object.keys(data).length){alert(L('Unable to parse CSV. Please check the format.','ç„¡æ³•è§£æ CSVï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚'));return;}
    monthlyData=data;sortedMonths=Object.keys(monthlyData).sort();lastFile=file.name;
    document.getElementById('filePill').innerHTML=buildPill();
    const latest=sortedMonths[sortedMonths.length-1];
    selMo={overview:latest,actions:latest};
    migPrev=sortedMonths.length>=2?sortedMonths[sortedMonths.length-2]:null;
    migCurr=sortedMonths.length>=2?latest:null;
    updateSubtitle();
    const st=computeStats(monthlyData[latest].members,latest);
    renderMonthSel(sortedMonths,latest,'selOv','ov-month-sel');
    document.getElementById('ov-content').innerHTML=renderOverview(st,latest);
    renderMonthSel(sortedMonths,latest,'selAc','ac-month-sel');
    document.getElementById('ac-content').innerHTML=renderActions(st,monthlyData[latest].members);
    renderMigSel(sortedMonths);
    switchTab('overview');
  };
  reader.readAsText(file);
}

/* ================================================================
   TAB SWITCHING
   ================================================================ */
function switchTab(id){
  curTab=id;
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  const btn=document.querySelector(`.tab[data-tab="${id}"]`);if(btn)btn.classList.add('active');
}
window.switchTab=switchTab;

/* ================================================================
   LANG TOGGLE
   ================================================================ */
function toggleLang(){
  lang=lang==='en'?'zh':'en';
  renderShell();
  if(sortedMonths.length){
    updateSubtitle();
    const o=selMo.overview,a=selMo.actions;
    if(o){renderMonthSel(sortedMonths,o,'selOv','ov-month-sel');document.getElementById('ov-content').innerHTML=renderOverview(computeStats(monthlyData[o].members,o),o);}
    if(a){renderMonthSel(sortedMonths,a,'selAc','ac-month-sel');document.getElementById('ac-content').innerHTML=renderActions(computeStats(monthlyData[a].members,a),monthlyData[a].members);}
    renderMigSel(sortedMonths);
  } else {
    document.getElementById('ov-content').innerHTML=`<p class="empty-state">${L('Please upload a CSV first','è«‹å…ˆä¸Šè¼‰ CSV')}</p>`;
    document.getElementById('ac-content').innerHTML=`<p class="empty-state">${L('Please upload a CSV first','è«‹å…ˆä¸Šè¼‰ CSV')}</p>`;
    document.getElementById('mig-content').innerHTML=`<p class="empty-state">${L('CSV must contain at least two data_month values','éœ€è¦åŒ…å«è‡³å°‘å…©å€‹ data_month çš„ CSV')}</p>`;
  }
}
window.toggleLang=toggleLang;

/* ================================================================
   INIT
   ================================================================ */
renderShell();
document.getElementById('ov-content').innerHTML=`<p class="empty-state">${L('Please upload a CSV first','è«‹å…ˆä¸Šè¼‰ CSV')}</p>`;
document.getElementById('ac-content').innerHTML=`<p class="empty-state">${L('Please upload a CSV first','è«‹å…ˆä¸Šè¼‰ CSV')}</p>`;
document.getElementById('mig-content').innerHTML=`<p class="empty-state">${L('CSV must contain at least two data_month values','éœ€è¦åŒ…å«è‡³å°‘å…©å€‹ data_month çš„ CSV')}</p>`;
</script>
</body>
</html>
